**User:**
Với cấu trúc dự án hiện tại có thể đưa toàn bộ control-plan, web-ui lên container?

**Claude Opus 4.5:**
Research containerization requirements

Read [](file:///home/zero-trust-net/infrastructure/docker/Dockerfile.control)

Read [](file:///home/zero-trust-net/web-ui/package.json)

Read [](file:///home/zero-trust-net/web-ui/vite.config.ts)

Read [](file:///home/zero-trust-net/control-plane/main.py#1-1), lines 1 to 100

Read [](file:///home/zero-trust-net/control-plane/pyproject.toml)

Read [](file:///home/zero-trust-net/infrastructure/docker)

Read [](file:///home/zero-trust-net/web-ui/src)

Read [](file:///home/zero-trust-net/control-plane/config.py#1-1), lines 1 to 80

Read [](file:///home/zero-trust-net/docker-compose.yml#1-1), lines 1 to 60

Read [](file:///home/zero-trust-net/web-ui/index.html)

Read [](file:///home/zero-trust-net/docker-compose.yml#60-60), lines 60 to 111

Read [](file:///home/zero-trust-net/web-ui/src/main.tsx)

Read [](file:///home/zero-trust-net/web-ui/src/App.tsx)

Read [](file:///home/zero-trust-net/web-ui/src/lib)

Read [](file:///home/zero-trust-net/web-ui/src/lib/api.ts#1-1), lines 1 to 60

Read [](file:///home/zero-trust-net/web-ui/tailwind.config.js)

Searched for files matching `**/Dockerfile.web*`, no matches

Read [](file:///home/zero-trust-net/pyproject.toml)

Searched for files matching `**/.env*`, 3 matches

Searched for text `VITE_`, 14 results

Read [](file:///home/zero-trust-net/.env.example)

Read [](file:///home/zero-trust-net/web-ui/.env.example)

## Plan: Containerize Control-Plane & Web-UI

Dựa trên cấu trúc hiện tại, hoàn toàn có thể đưa cả control-plane và web-ui lên container. Control-plane đã có Dockerfile sẵn, chỉ cần tạo thêm Dockerfile cho web-ui và cập nhật docker-compose.

### Steps

1. **Tạo Dockerfile.web** - Multi-stage build với Node 20 + Nginx Alpine, sử dụng `npm run build` để build Vite/React app, output static files vào Nginx

2. **Tạo nginx.conf** - Cấu hình Nginx để serve static files và proxy `/api/*`, `/ws/*` đến `control-plane:8000`

3. **Cập nhật docker-compose.yml** - Thêm service web-ui với build context, environment variables (`VITE_API_URL`, `VITE_ADMIN_TOKEN`), và labels cho Traefik routing

4. **Cấu hình biến môi trường** - Thêm `VITE_*` variables vào .env, sử dụng ARG trong Dockerfile để inject lúc build-time (Vite embeds variables at build)

5. **Cập nhật Traefik routing trong dynamic.yml** - Thêm router cho web-ui (frontend) và pathPrefix rules để route `/api` đến control-plane, `/` đến web-ui

### Further Considerations

1. **Build-time vs Runtime ENV?** Vite embed variables lúc build → cần rebuild image khi thay đổi API URL, hoặc dùng runtime config injection pattern với `window.__ENV__`

2. **Nginx hay để Traefik serve?** Option A: Nginx trong container (đơn giản, self-contained) / Option B: Multi-stage build chỉ lấy static files, mount vào Traefik (phức tạp hơn nhưng giảm containers)

3. **Database persistence?** Hiện dùng SQLite - cần volume mount `/app/zerotrust.db` hoặc chuyển sang PostgreSQL container cho production

---

**User:**
tôi sẽ dùng traefik để reverse proxy từ port 80, 443 đến control-plane port 8000 và web-ui port 3000 để tự động hóa ssl.

**Claude Opus 4.5:**
Research Traefik routing config

Read [](file:///home/zero-trust-net/infrastructure/docker/Dockerfile.control)

Read [](file:///home/zero-trust-net/web-ui/vite.config.ts)

Read [](file:///home/zero-trust-net/infrastructure/docker)

Read [](file:///home/zero-trust-net/docker-compose.yml)

Read [](file:///home/zero-trust-net/traefik)

Searched for text `nginx` (`**/infrastructure/docker/**`), no results

## Plan: Traefik Reverse Proxy với Auto SSL

Sử dụng Traefik làm reverse proxy cho cả control-plane và web-ui, với Let's Encrypt auto SSL. Routing dựa trên PathPrefix để phân biệt API vs Frontend.

### Steps

1. **Tạo Dockerfile.web** - Multi-stage build Node 20 Alpine, chạy `npm run dev` hoặc production build với static server (serve/http-server) để expose port 3000

2. **Tạo thư mục traefik/** với các files:
   - `acme.json` (chmod 600) - Lưu SSL certificates
   - `log/` directory - Access & error logs
   - `dynamic.yml` - Routing configuration

3. **Tạo traefik/dynamic.yml** - Cấu hình routing rules:
   - `/api/*`, `/ws/*` → `control-plane:8000` (priority: 100)
   - `/*` catch-all → `web-ui:3000` (priority: 1)
   - HTTP → HTTPS redirect middleware

4. **Cập nhật docker-compose.yml**:
   - Thêm service web-ui với build context web-ui
   - Xóa `ports: "8000:8000"` khỏi control-plane (chỉ expose qua Traefik)
   - Thêm Traefik labels cho cả 2 services (hoặc dùng file provider)
   - Thêm `depends_on` để đảm bảo thứ tự startup

5. **Cập nhật .env** - Thêm biến `DOMAIN` cho Traefik Host rule và `VITE_API_URL=/api/v1` cho web-ui build

### Further Considerations

1. **Docker Labels vs File Provider?** Option A: Labels trong docker-compose (self-contained, dễ quản lý) / Option B: dynamic.yml (tập trung, dễ đọc) - Recommend: **Labels** vì đã enable Docker provider

2. **Web-UI production mode?** Option A: `npm run dev` (hot reload, dev server) / Option B: `npm run build` + static server như `serve` (production-ready, nhỏ gọn) - Recommend: **Production build** với `serve` package

3. **Database volume?** Cần mount volume cho SQLite DB trong control-plane: `volumes: - ./data:/app/data` để persist data khi restart container

---

**User:**
nếu control-plane và web-ui chạy trên docker thì có nên chăng wireguard cũng chạy trên docker?

**Claude Opus 4.5:**
Đây là một câu hỏi kiến trúc quan trọng. Để trả lời, cần xem xét các khía cạnh kỹ thuật của WireGuard trong container.

## Plan: WireGuard Docker vs Native

### Phân tích hiện trạng

Trong docker-compose.yml hiện tại, WireGuard đã được cấu hình chạy trên Docker với `linuxserver/wireguard` image, yêu cầu capabilities đặc biệt (`NET_ADMIN`, `SYS_MODULE`) và mount modules.

### So sánh Docker vs Native

| Tiêu chí | WireGuard Docker | WireGuard Native |
|----------|------------------|------------------|
| **Deployment** | Đồng nhất với stack, một lệnh `docker-compose up` | Cần Ansible/script riêng |
| **Network isolation** | Phức tạp - cần `network_mode: host` hoặc port forwarding | Trực tiếp trên host network |
| **Performance** | ~5-10% overhead do NAT/bridge | Tối ưu, kernel-level |
| **Kernel module** | Phải mount modules, phụ thuộc host kernel | Native kernel support |
| **Firewall control** | iptables trong container, có thể conflict | Full control trên host |
| **Debugging** | Khó hơn (exec vào container) | Dễ dàng với `wg show` |
| **HA/Failover** | Container restart nhanh | Cần systemd management |

### Khuyến nghị: **WireGuard Native** (không dùng Docker)

**Lý do chính:**

1. **Zero Trust PEP** - WireGuard là Policy Enforcement Point, cần quyền truy cập trực tiếp vào network stack của host để thực thi firewall rules (`iptables ZT_ACL chain`)

2. **Agent integration** - Agent daemon cần tương tác với WireGuard interface (`wg syncconf`), chạy native đơn giản hơn

3. **Network complexity** - Docker networking thêm layer NAT, gây khó khăn cho overlay network routing

4. **Security** - `NET_ADMIN` + `SYS_MODULE` capabilities gần như cho container quyền root, mất lợi ích isolation

### Đề xuất kiến trúc

```
┌─────────────────────────────────────────────────────────┐
│                      HOST SERVER                         │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │              Docker Containers                   │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────┐  │    │
│  │  │control-plane│  │   web-ui    │  │ traefik │  │    │
│  │  │   :8000     │  │   :3000     │  │ :80/443 │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────┘  │    │
│  └─────────────────────────────────────────────────┘    │
│                          │                               │
│  ┌───────────────────────▼───────────────────────────┐  │
│  │              Native Services                       │  │
│  │  ┌─────────────────┐  ┌─────────────────────────┐ │  │
│  │  │   WireGuard     │  │   Agent (systemd)       │ │  │
│  │  │  wg0: 10.10.0.1 │  │   - Sync config         │ │  │
│  │  │  :51820/udp     │  │   - Apply iptables      │ │  │
│  │  └─────────────────┘  └─────────────────────────┘ │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### Steps nếu chuyển WireGuard sang Native

1. **Xóa service wireguard** khỏi docker-compose.yml

2. **Cài WireGuard native** qua Ansible role wireguard hoặc script install.sh

3. **Cấu hình control-plane** kết nối WireGuard qua `host.docker.internal` hoặc mount socket nếu cần

4. **Agent chạy native** (systemd) để quản lý WireGuard và iptables trực tiếp

### Further Considerations

1. **Giữ WireGuard Docker cho dev/testing?** Có thể tạo 2 profiles: docker-compose.yml (full Docker cho dev) và `docker-compose.prod.yml` (chỉ control-plane, web-ui, traefik)

2. **Control-plane cần gọi `wg` command?** Nếu có, cần mount WireGuard socket hoặc chạy control-plane với `network_mode: host` (không khuyến nghị)

3. **Nếu vẫn muốn Docker WireGuard?** Dùng `network_mode: host` thay vì port mapping để tránh NAT overhead và có full network access

---
**User:**
control-plane bằng cách nào từ docker mà điều khiển được wireguard, ansible?

**Claude Opus 4.5:**
Research control-plane WireGuard interaction

Read [](file:///home/zero-trust-net/control-plane/core/wireguard_service.py)

Read [](file:///home/zero-trust-net/control-plane/main.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/control-plane/core/node_manager.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/wireguard/manager.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/wireguard/manager.py#200-200), lines 200 to 281

Read [](file:///home/zero-trust-net/control-plane/core/node_manager.py#200-200), lines 200 to 498

Searched for regex `ansible|Ansible|playbook|ssh|SSH|paramiko` (`**/control-plane/**`), 17 results

Searched for regex `subprocess|socket|file|mount` (`**/control-plane/core/**`), 20 results

Read [](file:///home/zero-trust-net/control-plane/core/event_handlers.py#1-1), lines 1 to 100

Read [](file:///home/zero-trust-net/control-plane/core/client_manager.py#1-1), lines 1 to 100

Searched for regex `websocket|WebSocket|sync|config` (`**/control-plane/api/v1/**`), 20 results

Read [](file:///home/zero-trust-net/control-plane/core/event_handlers.py#90-90), lines 90 to 250

Read [](file:///home/zero-trust-net/control-plane/api/v1/websocket.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/control-plane/api/v1/agent.py#1-1), lines 1 to 100

Read [](file:///home/zero-trust-net/agent/agent.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/agent/websocket_client.py#1-1), lines 1 to 100

Read [](file:///home/zero-trust-net/agent/client.py#1-1), lines 1 to 100

Read [](file:///home/zero-trust-net/docker-compose.yml#1-1), lines 1 to 100

## Plan: Control-Plane trong Docker điều khiển WireGuard/Ansible

### Tình trạng hiện tại

Control-plane sử dụng **subprocess calls** (`wg`, `wg-quick`) trong wireguard_service.py để quản lý WireGuard trên Hub. Không có Ansible integration trong runtime code.

### Vấn đề khi chạy Control-Plane trong Docker

| Vấn đề | Mô tả |
|--------|-------|
| `wg` command | Không có trong container |
| `NET_ADMIN` capability | Cần để thực thi `wg set` |
| wireguard | Cần mount để đọc/ghi config |
| Network namespace | Container có namespace riêng, không thấy host wg0 |

### 3 Phương án giải quyết

#### Option A: Mount + Capabilities (Đơn giản nhưng kém bảo mật)

```yaml
control-plane:
  cap_add:
    - NET_ADMIN
  network_mode: host
  volumes:
    - /etc/wireguard:/etc/wireguard
    - /usr/bin/wg:/usr/bin/wg:ro
    - /usr/bin/wg-quick:/usr/bin/wg-quick:ro
```

**Pros:** Nhanh, ít thay đổi code
**Cons:** Container có quyền root-like, mất isolation

---

#### Option B: WireGuard Agent trên Host (Khuyến nghị ✅)

Tách WireGuard management ra Agent chạy native trên host:

```
┌────────────────────────────────────────────────────────┐
│                    Docker                              │
│  ┌──────────────┐  ┌─────────┐  ┌─────────────────┐   │
│  │control-plane │  │ web-ui  │  │     traefik     │   │
│  │  (API only)  │  │         │  │                 │   │
│  └──────┬───────┘  └─────────┘  └─────────────────┘   │
│         │ HTTP/WebSocket                               │
└─────────┼──────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────┐
│                 Host (Native)                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Hub Agent (systemd)                 │   │
│  │  - Kết nối WebSocket đến control-plane           │   │
│  │  - Nhận lệnh add/remove peer                    │   │
│  │  - Thực thi wg set, wg-quick, iptables          │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │ subprocess                    │
│  ┌─────────────────────▼───────────────────────────┐   │
│  │              WireGuard wg0                       │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

**Cách hoạt động:**
1. Control-plane gửi commands qua WebSocket đến Hub Agent
2. Hub Agent thực thi `wg set`, `wg-quick` trên host
3. Giữ nguyên code wireguard_service.py nhưng chuyển từ subprocess → WebSocket message

**Pros:** Bảo mật, đúng Zero Trust architecture, Agent đã có sẵn
**Cons:** Cần refactor code, thêm complexity

---

#### Option C: WireGuard API Container (Advanced)

Tạo container riêng với REST API để quản lý WireGuard:

```yaml
wg-api:
  image: custom/wireguard-api
  cap_add: [NET_ADMIN]
  network_mode: host
  volumes:
    - /etc/wireguard:/etc/wireguard
```

Control-plane gọi HTTP API thay vì subprocess.

**Pros:** Tách biệt concerns, có thể scale
**Cons:** Thêm 1 container, vẫn cần NET_ADMIN

---

### Về Ansible

Ansible **không cần** tích hợp runtime vào control-plane vì:
- Ansible dùng cho **deployment** (cài đặt, provision)
- Runtime management dùng **Agent + WebSocket**

Nếu cần provision node mới tự động, có thể:
1. Control-plane tạo inventory file → trigger Ansible playbook
2. Hoặc dùng **AWX/Ansible Tower API** để trigger jobs

---

### Khuyến nghị kiến trúc cuối cùng

| Component | Runtime | Lý do |
|-----------|---------|-------|
| **control-plane** | Docker | Stateless API, dễ scale |
| **web-ui** | Docker | Static frontend |
| **traefik** | Docker | Reverse proxy |
| **WireGuard** | Native | Cần kernel access |
| **Hub Agent** | Native (systemd) | Thực thi WireGuard + iptables |
| **Database** | Docker (PostgreSQL) | Dễ backup/restore |

### Further Considerations

1. **Refactor cần thiết?** Nếu chọn Option B, cần thêm WebSocket command handler trong Agent để nhận lệnh từ control-plane (add_peer, remove_peer, get_status)

2. **Database persistence?** Hiện dùng SQLite, nên chuyển sang PostgreSQL container với volume mount để persist data

3. **Development workflow?** Có thể giữ Option A cho dev/testing local, Option B cho production


---
**User:**
Với kiến trúc này:
```
┌────────────────────────────────────────────────────────┐
│                    Docker                              │
│  ┌──────────────┐  ┌─────────┐  ┌─────────────────┐   │
│  │control-plane │  │ web-ui  │  │     traefik     │   │
│  │  (API only)  │  │         │  │                 │   │
│  └──────┬───────┘  └─────────┘  └─────────────────┘   │
│         │ HTTP/WebSocket                               │
└─────────┼──────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────┐
│                 Host (Native)                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Hub Agent (systemd)                 │   │
│  │  - Kết nối WebSocket đến control-plane           │   │
│  │  - Nhận lệnh add/remove peer                    │   │
│  │  - Thực thi wg set, wg-quick, iptables          │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │ subprocess                    │
│  ┌─────────────────────▼───────────────────────────┐   │
│  │              WireGuard wg0                       │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```
Thì khi tắt docker hệ thống vẫn hoạt động?
Nâng cấp `control-plane` không bị quá nhiều phụ thuộc?
Hệ thống có gia tăng khả năng chịu lỗi?
Có thể đổi `control-plane` sang server khác?
Hệ thống có thể chọn lựa `WireGuard` native trên server khác để di dời và High Availability?


**Claude Opus 4.5:**

## Plan: Đánh giá kiến trúc Hybrid Docker + Native

Phân tích 5 câu hỏi về khả năng chịu lỗi và mở rộng của kiến trúc đề xuất.

### Phân tích chi tiết

#### 1. Khi tắt Docker, hệ thống vẫn hoạt động?

| Thành phần | Trạng thái khi Docker down | Hậu quả |
|------------|---------------------------|---------|
| WireGuard wg0 | ✅ **Vẫn chạy** | VPN tunnel giữa các nodes vẫn hoạt động |
| Hub Agent | ✅ **Vẫn chạy** | Heartbeat fail nhưng config đã apply vẫn giữ nguyên |
| iptables rules | ✅ **Vẫn giữ** | Firewall rules đã apply không bị mất |
| Nodes kết nối | ✅ **Vẫn kết nối** | Peer-to-peer qua WireGuard vẫn thông |
| Đăng ký node mới | ❌ **Không được** | Cần control-plane để approve |
| Thay đổi policy | ❌ **Không được** | Cần control-plane để sync |
| Web dashboard | ❌ **Không truy cập** | web-ui trong Docker |

**Kết luận:** Hệ thống **degraded gracefully** - VPN network vẫn hoạt động với cấu hình cuối cùng, chỉ mất khả năng quản lý.

---

#### 2. Nâng cấp control-plane không bị quá nhiều phụ thuộc?

```
┌─────────────────────────────────────────────────────────┐
│  Nâng cấp Control-Plane                                 │
├─────────────────────────────────────────────────────────┤
│  docker-compose pull control-plane                      │
│  docker-compose up -d control-plane                     │
│                                                         │
│  Thời gian downtime: ~5-10 giây                        │
│  Ảnh hưởng: Chỉ API tạm ngưng                          │
│  WireGuard: Không ảnh hưởng ✅                          │
│  Existing connections: Không ảnh hưởng ✅               │
└─────────────────────────────────────────────────────────┘
```

**Phụ thuộc khi upgrade:**

| Dependency | Kiến trúc cũ (all-in-one) | Kiến trúc mới (hybrid) |
|------------|---------------------------|------------------------|
| WireGuard restart | ❌ Có thể cần | ✅ Không cần |
| Network disruption | ❌ Có thể xảy ra | ✅ Không |
| Agent reconnect | ⚠️ Cần | ⚠️ Cần (auto-reconnect) |
| Database migration | ⚠️ Nếu có | ⚠️ Nếu có |

**Kết luận:** **Ít phụ thuộc hơn** - chỉ cần restart container, không ảnh hưởng network layer.

---

#### 3. Hệ thống có gia tăng khả năng chịu lỗi?

| Failure Scenario | Kiến trúc cũ | Kiến trúc Hybrid |
|------------------|--------------|------------------|
| Control-plane crash | ❌ Mất WireGuard nếu cùng process | ✅ WireGuard vẫn chạy |
| Docker daemon crash | ❌ Mất tất cả | ✅ WireGuard + Agent vẫn chạy |
| Database corruption | ❌ Mất quản lý | ⚠️ Mất quản lý (nhưng network vẫn up) |
| Memory leak trong API | ❌ Có thể ảnh hưởng WireGuard | ✅ Isolated trong container |
| Host reboot | ⚠️ Cần đợi tất cả khởi động | ✅ WireGuard up trước, API sau |

**Fault Isolation Matrix:**

```
┌─────────────────────────────────────────────────────────┐
│                 FAILURE DOMAIN ISOLATION                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Docker Domain          │    Host Domain               │
│  ┌─────────────────┐   │   ┌─────────────────────┐    │
│  │ control-plane   │   │   │     WireGuard       │    │
│  │ web-ui          │   │   │     Hub Agent       │    │
│  │ traefik         │   │   │     iptables        │    │
│  │ (postgresql)    │   │   │                     │    │
│  └─────────────────┘   │   └─────────────────────┘    │
│         ↓              │            ↓                  │
│   Management fails     │     Network continues        │
│                        │                               │
└─────────────────────────────────────────────────────────┘
```

**Kết luận:** **Có** - Tách biệt failure domain giữa Management (Docker) và Network (Native).

---

#### 4. Có thể đổi control-plane sang server khác?

**✅ CÓ** - Đây là ưu điểm lớn của kiến trúc này:

```
┌─────────────────────────────────────────────────────────┐
│  Server A (WireGuard Hub)     Server B (Control Plane)  │
│  ┌─────────────────────┐     ┌─────────────────────┐   │
│  │ WireGuard wg0       │     │ Docker              │   │
│  │ 10.10.0.1           │     │ ┌─────────────────┐ │   │
│  │                     │     │ │ control-plane   │ │   │
│  │ Hub Agent ──────────┼─────┼─│ :8000           │ │   │
│  │   (WebSocket)       │     │ │                 │ │   │
│  │                     │     │ └─────────────────┘ │   │
│  └─────────────────────┘     │ ┌─────────────────┐ │   │
│                              │ │ web-ui          │ │   │
│  Server C, D, E...           │ │ traefik         │ │   │
│  ┌─────────────────────┐     │ │ postgresql      │ │   │
│  │ Node Agents ────────┼─────┼─└─────────────────┘ │   │
│  └─────────────────────┘     └─────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

**Yêu cầu để migrate:**
1. Agent cấu hình `CONTROL_PLANE_URL` (có thể là domain/IP của server B)
2. Database backup/restore
3. SSL certificate (Traefik auto-renew)

**Kết luận:** Control-plane hoàn toàn **stateless** (trừ DB), có thể chạy trên bất kỳ server nào.

---

#### 5. Có thể chọn WireGuard native trên server khác để HA?

**✅ CÓ** - Nhưng cần thiết kế thêm:

```
┌─────────────────────────────────────────────────────────────┐
│              HIGH AVAILABILITY ARCHITECTURE                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐      ┌─────────────────┐               │
│  │ WG Hub Primary  │      │ WG Hub Secondary│               │
│  │ 10.10.0.1       │      │ 10.10.0.2       │               │
│  │ wg.primary.com  │      │ wg.secondary.com│               │
│  └────────┬────────┘      └────────┬────────┘               │
│           │                        │                         │
│           └────────────┬───────────┘                         │
│                        │ Peers sync via                      │
│                        │ Control-Plane                       │
│                        ▼                                     │
│           ┌─────────────────────────┐                        │
│           │    Control Plane        │                        │
│           │  (manages both hubs)    │                        │
│           └─────────────────────────┘                        │
│                                                              │
│  Node agents configure multiple endpoints:                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ [Peer]                                               │    │
│  │ Endpoint = wg.primary.com:51820                      │    │
│  │ # Failover handled by DNS or agent logic             │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

**HA Strategies:**

| Strategy | Complexity | Failover Time |
|----------|------------|---------------|
| DNS Failover | Thấp | 30s - 5min (TTL) |
| Agent multi-endpoint | Trung bình | 5-10s |
| Floating IP (Keepalived) | Cao | 1-3s |
| Anycast | Rất cao | <1s |

**Cần implement thêm:**
1. Control-plane quản lý multiple WireGuard hubs
2. Peer sync giữa các hubs
3. Agent health check và failover logic

---

### Tổng kết

| Câu hỏi | Trả lời | Ghi chú |
|---------|---------|---------|
| Docker down, hệ thống vẫn chạy? | ✅ **Có** | VPN network vẫn up |
| Upgrade ít phụ thuộc? | ✅ **Có** | Chỉ restart container |
| Gia tăng fault tolerance? | ✅ **Có** | Failure domain isolation |
| Đổi control-plane sang server khác? | ✅ **Có** | Stateless design |
| HA WireGuard trên nhiều server? | ⚠️ **Có thể** | Cần implement thêm |

### Further Considerations

1. **Database HA?** Nếu dùng PostgreSQL, cần replica hoặc managed database (RDS, CloudSQL) để tránh single point of failure

2. **Control-plane HA?** Có thể chạy multiple instances behind load balancer, cần shared database và sticky sessions cho WebSocket

3. **Agent reconnect logic?** Cần implement exponential backoff và multi-endpoint fallback trong websocket_client.py

---

**User:**
Thiết kế `hub-agent` (native):
```
┌────────────────────────────────────────────────────────┐
│                    Docker                              │
│  ┌──────────────┐  ┌─────────┐  ┌─────────────────┐   │
│  │control-plane │  │ web-ui  │  │     traefik     │   │
│  │  (API only)  │  │         │  │                 │   │
│  └──────┬───────┘  └─────────┘  └─────────────────┘   │
│         │ HTTP/WebSocket                               │
└─────────┼──────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────┐
│                 Host (Native)                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Hub Agent (systemd)                 │   │
│  │  - Kết nối WebSocket đến control-plane           │   │
│  │  - Nhận lệnh add/remove peer                    │   │
│  │  - Thực thi wg set, wg-quick, iptables          │   │
│  └─────────────────────┬───────────────────────────┘   │
│                        │ subprocess                    │
│  ┌─────────────────────▼───────────────────────────┐   │
│  │              WireGuard wg0                       │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘

```

**Claude Opus 4.5:**
Research current agent architecture

Read [](file:///home/zero-trust-net/agent/agent.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/websocket_client.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/wireguard/manager.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/firewall/iptables.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/control-plane/core/wireguard_service.py)

Read [](file:///home/zero-trust-net/control-plane/core/client_manager.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/control-plane/core/domain_events.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/control-plane/core/events.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/agent/agent.py#200-200), lines 200 to 400

Read [](file:///home/zero-trust-net/agent/websocket_client.py#200-200), lines 200 to 350

Read [](file:///home/zero-trust-net/control-plane/core/client_manager.py#200-200), lines 200 to 432

Read [](file:///home/zero-trust-net/control-plane/core/domain_events.py#150-150), lines 150 to 260

Read [](file:///home/zero-trust-net/control-plane/core/event_handlers.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/wireguard/manager.py#200-200), lines 200 to 280

Read [](file:///home/zero-trust-net/agent/agent.py#400-400), lines 400 to 496

Read [](file:///home/zero-trust-net/control-plane/core/event_handlers.py#200-200), lines 200 to 336

Searched for regex `WebSocket|ws/agent|message.*type` (`**/control-plane/api/**`), 20 results

Searched for files matching `**/api/v1/*.py`, 7 matches

Read [](file:///home/zero-trust-net/control-plane/api/v1/websocket.py#1-1), lines 1 to 250

Read [](file:///home/zero-trust-net/control-plane/api/v1/agent.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/control-plane/api/v1/websocket.py#250-250), lines 250 to 337

Read [](file:///home/zero-trust-net/control-plane/api/v1/agent.py#150-150), lines 150 to 300

Read [](file:///home/zero-trust-net/control-plane/api/v1/agent.py#300-300), lines 300 to 450

Read [](file:///home/zero-trust-net/agent/websocket_client.py#350-350), lines 350 to 462

## Plan: Thiết kế Hub-Agent (Native)

Hub-Agent là daemon chạy native trên host, nhận lệnh từ control-plane (Docker) qua WebSocket để quản lý WireGuard và firewall.

### Kiến trúc Hub-Agent

```
┌──────────────────────────────────────────────────────────────────────┐
│                         HUB-AGENT (Python/systemd)                   │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │
│  │  WebSocket      │    │   Command       │    │   Status        │  │
│  │  Client         │───▶│   Handler       │───▶│   Reporter      │  │
│  │  (reconnect)    │    │                 │    │                 │  │
│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘  │
│           │                      │                      │           │
│           │    ┌─────────────────┴──────────────────────┘           │
│           │    │                                                    │
│           │    ▼                                                    │
│  ┌────────┴────────────────────────────────────────────────────┐   │
│  │                    Managers                                  │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │   │
│  │  │ WireGuardManager│  │ FirewallManager │  │ MetricsCollector│ │
│  │  │ - add_peer()    │  │ - apply_rules() │  │ - peer_stats()│ │   │
│  │  │ - remove_peer() │  │ - hub ACLs      │  │ - bandwidth() │ │   │
│  │  │ - sync_peers()  │  │                 │  │               │ │   │
│  │  └────────┬────────┘  └────────┬────────┘  └───────────────┘ │   │
│  └───────────┼────────────────────┼─────────────────────────────┘   │
│              │                    │                                 │
│              ▼                    ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              subprocess: wg, wg-quick, iptables              │   │
│  └─────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────┘
```

### So sánh Node-Agent vs Hub-Agent

| Aspect | Node-Agent | Hub-Agent |
|--------|------------|-----------|
| **Vị trí** | Mỗi VPS node | Hub server (native) |
| **WireGuard role** | Client (kết nối TỚI hub) | Server (nhận kết nối TỪ nodes) |
| **Peers** | Chỉ 1 peer (hub) | Tất cả nodes + clients |
| **Đăng ký** | POST `/register` | Không đăng ký (xác thực bằng API key) |
| **Commands nhận** | `config_update`, `acl_update` | `add_peer`, `remove_peer`, `sync_peers` |
| **Firewall** | ACL rules cho node này | Hub-level rules (optional) |

### Steps

#### 1. Tạo cấu trúc thư mục Hub-Agent

```
agent/
├── agent.py              # Node agent (existing)
├── hub_agent.py          # NEW: Hub agent daemon
├── hub_commands.py       # NEW: Command handlers
├── client.py
├── websocket_client.py
├── wireguard/
│   ├── manager.py        # Reuse
│   └── config_builder.py
├── firewall/
│   └── iptables.py       # Reuse
└── collectors/           # Reuse for metrics
```

#### 2. Implement hub_agent.py

```python
class HubAgent:
    """Hub Agent - receives commands from Control Plane"""

    # Authentication
    api_key: str  # Shared secret with control-plane

    # Components (reuse from node agent)
    wg_manager: WireGuardManager
    firewall_manager: IPTablesManager

    # WebSocket connection
    ws_url: str = "ws://localhost:8000/api/v1/ws/hub"

    async def run():
        """Main loop: connect WebSocket, handle commands"""

    async def handle_command(cmd: dict):
        """Route commands to appropriate handler"""
```

#### 3. Implement Command Handlers trong hub_commands.py

| Command Type | Handler | Action |
|--------------|---------|--------|
| `add_peer` | `handle_add_peer()` | `wg set wg0 peer <key> allowed-ips <ip>` |
| `remove_peer` | `handle_remove_peer()` | `wg set wg0 peer <key> remove` |
| `sync_peers` | `handle_sync_peers()` | Reconcile peers với danh sách từ control-plane |
| `get_status` | `handle_get_status()` | Return `wg show wg0 dump` |
| `restart_interface` | `handle_restart()` | `wg-quick down/up wg0` |

#### 4. Thêm WebSocket endpoint trong Control-Plane api/v1/hub.py

```python
@router.websocket("/ws/hub")
async def hub_websocket(websocket: WebSocket, api_key: str = Query(...)):
    """
    Dedicated WebSocket for Hub-Agent
    - Authenticate via API key (not node registration)
    - Send commands: add_peer, remove_peer, sync_peers
    - Receive status: command_result, interface_status
    """
```

#### 5. Refactor wireguard_service.py

**Trước (subprocess trực tiếp):**
```python
async def add_peer(self, public_key: str, allowed_ips: str):
    subprocess.run(["wg", "set", "wg0", "peer", public_key, ...])
```

**Sau (gửi command qua WebSocket):**
```python
async def add_peer(self, public_key: str, allowed_ips: str):
    await hub_manager.send_command({
        "type": "add_peer",
        "public_key": public_key,
        "allowed_ips": allowed_ips
    })
```

#### 6. Tạo systemd service hub-agent.service

```ini
[Unit]
Description=Zero Trust Hub Agent
After=network.target docker.service
Wants=docker.service

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/hub-agent --api-key ${HUB_API_KEY}
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### WebSocket Message Protocol

**Control-Plane → Hub-Agent:**
```json
{
  "command_id": "uuid",
  "type": "add_peer",
  "payload": {
    "public_key": "xxx",
    "allowed_ips": "10.10.0.5/32",
    "preshared_key": "optional"
  }
}
```

**Hub-Agent → Control-Plane:**
```json
{
  "command_id": "uuid",
  "type": "command_result",
  "success": true,
  "error": null
}
```

**Hub-Agent Status Report (periodic):**
```json
{
  "type": "interface_status",
  "interface": "wg0",
  "listen_port": 51820,
  "peers": [
    {
      "public_key": "xxx",
      "allowed_ips": "10.10.0.5/32",
      "latest_handshake": 1703851234,
      "transfer_rx": 123456,
      "transfer_tx": 654321
    }
  ]
}
```

### Startup Sequence

```
┌─────────────────────────────────────────────────────────────────┐
│  HUB SERVER BOOT                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. WireGuard wg0 interface up (systemd-networkd hoặc wg-quick)│
│     └── Loads /etc/wireguard/wg0.conf                          │
│                                                                 │
│  2. Docker daemon starts                                        │
│     └── docker-compose up (control-plane, web-ui, traefik)     │
│                                                                 │
│  3. Hub-Agent starts (After=docker.service)                    │
│     └── Connects WebSocket to localhost:8000                   │
│     └── Reports current WireGuard status                       │
│     └── Control-plane syncs peers if needed                    │
│                                                                 │
│  4. Ready to accept commands                                   │
│     └── Node registers → control-plane → hub-agent → wg set   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Further Considerations

1. **Reconnection strategy?** Hub-Agent cần exponential backoff khi control-plane restart. Có thể cache commands locally và retry.

2. **Command queue?** Nếu Hub-Agent disconnect, control-plane nên queue commands và replay khi reconnect. Hoặc dùng `sync_peers` để reconcile.

3. **Security - API Key rotation?** Có thể dùng mutual TLS thay vì API key, hoặc rotate key định kỳ qua secure channel.

4. **Multiple hubs (HA)?** Control-plane cần track multiple hub-agent connections và route `add_peer` đến tất cả hubs.


---

**User:**
Tạo cấu trúc thư mục `agent` :
agent/
├── hub/
├── node/


Tách biệt không sử dụng chung code tránh ảnh hưởng khi nâng cấp.

**Claude Opus 4.5:**
Research current agent structure

Searched for files matching `**/agent/**`, 30 matches

Read [](file:///home/zero-trust-net/agent/agent.py#1-1), lines 1 to 300

Read [](file:///home/zero-trust-net/agent/websocket_client.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/client.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/client.py#200-200), lines 200 to 218

Read [](file:///home/zero-trust-net/agent/wireguard/manager.py)

Read [](file:///home/zero-trust-net/agent/wireguard/config_builder.py#1-1), lines 1 to 200

Read [](file:///home/zero-trust-net/agent/firewall/iptables.py)

Read [](file:///home/zero-trust-net/agent/collectors/__init__.py)

Read [](file:///home/zero-trust-net/agent/pyproject.toml)

Read [](file:///home/zero-trust-net/agent/collectors/host_info.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/agent/collectors/security_events.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/agent/collectors/network_stats.py#1-1), lines 1 to 150

Read [](file:///home/zero-trust-net/agent/collectors/agent_integrity.py)

Read [](file:///home/zero-trust-net/agent/firewall/nftables.py)

Read [](file:///home/zero-trust-net/agent/agent.py#300-300), lines 300 to 496

Read [](file:///home/zero-trust-net/agent/websocket_client.py#200-200), lines 200 to 462

Read [](file:///home/zero-trust-net/agent)

## Plan: Tách Agent thành Hub và Node

Tách biệt hoàn toàn `hub/` và `node/` **không dùng chung code** để tránh coupling và ảnh hưởng khi nâng cấp độc lập.

### Cấu trúc thư mục đề xuất

```
agent/
├── hub/                              # Hub Agent (native trên hub server)
│   ├── __init__.py
│   ├── pyproject.toml               # Dependencies riêng cho hub
│   ├── hub_agent.py                 # Main daemon
│   ├── websocket_handler.py         # WebSocket connection to control-plane
│   ├── command_executor.py          # Execute commands from control-plane
│   ├── wireguard/
│   │   ├── __init__.py
│   │   ├── manager.py               # WireGuard server mode management
│   │   └── peer_manager.py          # Manage all node/client peers
│   ├── firewall/
│   │   ├── __init__.py
│   │   ├── iptables.py              # Hub-level firewall rules
│   │   └── forwarding.py            # IP forwarding, NAT masquerade
│   └── status/
│       ├── __init__.py
│       ├── interface_status.py      # wg show wg0 dump
│       └── peer_stats.py            # Peer handshake, transfer stats
│
├── node/                             # Node Agent (trên mỗi VPS)
│   ├── __init__.py
│   ├── pyproject.toml               # Dependencies riêng cho node
│   ├── agent.py                     # Main daemon (current agent.py)
│   ├── client.py                    # HTTP client to control-plane
│   ├── websocket_client.py          # WebSocket to control-plane
│   ├── wireguard/
│   │   ├── __init__.py
│   │   ├── manager.py               # WireGuard client mode
│   │   └── config_builder.py        # Build wg0.conf from API response
│   ├── firewall/
│   │   ├── __init__.py
│   │   └── iptables.py              # Node ACL rules (ZT_ACL chain)
│   └── collectors/
│       ├── __init__.py
│       ├── host_info.py             # OS, platform info
│       ├── network_stats.py         # Connection stats
│       ├── security_events.py       # SSH failures, firewall drops
│       └── agent_integrity.py       # File hash for trust
│
└── README.md                         # Documentation
```

### So sánh Hub vs Node

| Aspect | Hub Agent | Node Agent |
|--------|-----------|------------|
| **Vị trí** | Hub server (native) | Mỗi VPS node |
| **WireGuard mode** | Server (ListenPort) | Client (Endpoint) |
| **Kết nối** | WebSocket từ control-plane | WebSocket đến control-plane |
| **Peers** | Tất cả nodes + clients | Chỉ hub |
| **Commands** | `add_peer`, `remove_peer` | `config_update`, `acl_update` |
| **Đăng ký** | Không (xác thực API key) | POST `/register` |
| **Collectors** | Không cần | Trust scoring metrics |
| **IP Forward** | Có (`sysctl`) | Không |

### Steps

#### 1. Tạo cấu trúc agent/hub/

| File | Mô tả |
|------|-------|
| `hub_agent.py` | Main daemon, lifecycle management |
| `websocket_handler.py` | Kết nối WebSocket đến `localhost:8000/api/v1/ws/hub` |
| `command_executor.py` | Route và execute commands từ control-plane |
| `wireguard/manager.py` | Server mode: `wg set`, `wg-quick`, không có Endpoint |
| `wireguard/peer_manager.py` | Add/remove/sync peers, track peer states |
| `firewall/iptables.py` | Hub-level rules, FORWARD chain |
| `firewall/forwarding.py` | Enable IP forward, NAT masquerade |
| `status/interface_status.py` | Parse `wg show wg0 dump` |
| `status/peer_stats.py` | Peer handshake times, transfer stats |

#### 2. Di chuyển code hiện tại sang agent/node/

| Source | Destination |
|--------|-------------|
| agent.py | `agent/node/agent.py` |
| client.py | `agent/node/client.py` |
| websocket_client.py | `agent/node/websocket_client.py` |
| `agent/wireguard/*` | `agent/node/wireguard/*` |
| `agent/firewall/*` | `agent/node/firewall/*` |
| `agent/collectors/*` | `agent/node/collectors/*` |

#### 3. Tạo agent/hub/pyproject.toml

```toml
[project]
name = "zt-hub-agent"
version = "1.0.0"
requires-python = ">=3.10"
dependencies = [
    "websockets>=12.0",  # WebSocket client
]

[project.scripts]
hub-agent = "hub_agent:main"
```

#### 4. Tạo agent/node/pyproject.toml

```toml
[project]
name = "zt-node-agent"
version = "1.0.0"
requires-python = ">=3.10"
dependencies = []

[project.optional-dependencies]
full = ["psutil>=5.9.8", "distro>=1.9.0"]

[project.scripts]
node-agent = "agent:main"
```

#### 5. Cập nhật Ansible roles

| Role | Mô tả |
|------|-------|
| `roles/hub-agent/` | Cài đặt hub-agent, systemd service |
| `roles/node-agent/` | Cài đặt node-agent (rename từ `roles/agent/`) |

#### 6. Cập nhật install scripts

| Script | Thay đổi |
|--------|----------|
| install.sh | Cài hub-agent từ `agent/hub/` |
| install.sh | Cài node-agent từ `agent/node/` |

### Diagram: Tách biệt hoàn toàn

```
┌─────────────────────────────────────────────────────────────────┐
│                         REPOSITORY                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  agent/hub/                      agent/node/                     │
│  ┌─────────────────────┐        ┌─────────────────────┐         │
│  │ zt-hub-agent        │        │ zt-node-agent       │         │
│  │                     │        │                     │         │
│  │ - WebSocket handler │        │ - HTTP client       │         │
│  │ - Command executor  │        │ - WebSocket client  │         │
│  │ - Peer manager      │        │ - Config builder    │         │
│  │ - Status reporter   │        │ - Collectors        │         │
│  │                     │        │                     │         │
│  │ NO SHARED CODE      │        │ NO SHARED CODE      │         │
│  │ ══════════════      │        │ ══════════════      │         │
│  └─────────────────────┘        └─────────────────────┘         │
│            │                              │                      │
│            │ Install on                   │ Install on           │
│            ▼ Hub Server                   ▼ Each Node            │
│  ┌─────────────────────┐        ┌─────────────────────┐         │
│  │ systemd:            │        │ systemd:            │         │
│  │ hub-agent.service   │        │ node-agent.service  │         │
│  └─────────────────────┘        └─────────────────────┘         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Lợi ích của việc tách biệt

| Lợi ích | Mô tả |
|---------|-------|
| **Độc lập phiên bản** | Hub v2.0, Node v1.5 - upgrade riêng lẻ |
| **Không coupling** | Thay đổi hub không ảnh hưởng node |
| **Dependencies riêng** | Hub cần `websockets`, Node không cần |
| **Testing độc lập** | Unit test từng agent riêng |
| **Deployment linh hoạt** | Chỉ cài package cần thiết |

### Further Considerations

1. **Versioning strategy?** Dùng independent versioning (hub v1.0, node v1.0) hay coupled versioning (cả 2 cùng version)?

2. **Shared constants?** Nếu có constants chung (message types, error codes), tạo `agent/shared/constants.py` hay duplicate? Recommend: **Duplicate** để giữ độc lập hoàn toàn.

3. **Monorepo hay separate repos?** Hiện tại giữ monorepo cho dễ quản lý. Có thể tách repo riêng sau nếu team lớn.


---
