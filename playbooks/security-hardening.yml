---
# =============================================================================
# SECURITY HARDENING PLAYBOOK - Enterprise Grade
# =============================================================================
# 
# Áp dụng các biện pháp bảo mật cấp doanh nghiệp cho tất cả nodes
#
# Bao gồm:
#   - SSH Hardening
#   - Firewall (UFW/iptables)
#   - Fail2ban
#   - Audit logging
#   - Kernel hardening
#   - Automatic updates
#
# Sử dụng:
#   ansible-playbook playbooks/security-hardening.yml
#   ansible-playbook playbooks/security-hardening.yml --tags ssh
#   ansible-playbook playbooks/security-hardening.yml --tags firewall
#
# =============================================================================

- name: Security Hardening - Enterprise Grade
  hosts: all:!local
  become: yes
  vars:
    # WireGuard network CIDR
    wireguard_network: "10.10.0.0/24"
    
    # SSH settings
    ssh_port: 22
    ssh_permit_root: "prohibit-password"  # Chỉ cho phép key-based
    ssh_password_auth: "no"
    ssh_max_auth_tries: 3
    ssh_client_alive_interval: 300
    ssh_client_alive_count: 2
    
    # Fail2ban settings
    fail2ban_bantime: 3600      # 1 hour
    fail2ban_findtime: 600      # 10 minutes
    fail2ban_maxretry: 3
    
    # Allowed services per zone
    control_plane_ports:
      - { port: 22, proto: tcp, comment: "SSH" }
      - { port: 51820, proto: udp, comment: "WireGuard" }
    
    worker_ports:
      - { port: 22, proto: tcp, comment: "SSH (WireGuard only)" }
      - { port: 51820, proto: udp, comment: "WireGuard" }

  tasks:
    # =========================================================================
    # PHASE 1: System Updates & Base Packages
    # =========================================================================
    - name: "PHASE 1: System Updates"
      tags: [base, updates]
      block:
        - name: Update apt cache
          apt:
            update_cache: yes
            cache_valid_time: 3600

        - name: Upgrade all packages
          apt:
            upgrade: safe
          when: security_upgrade | default(false)

        - name: Install security packages
          apt:
            name:
              - fail2ban
              - ufw
              - auditd
              - audispd-plugins
              - unattended-upgrades
              - apt-listchanges
              - logwatch
              - rkhunter
              - chkrootkit
            state: present

    # =========================================================================
    # PHASE 2: SSH Hardening
    # =========================================================================
    - name: "PHASE 2: SSH Hardening"
      tags: [ssh]
      block:
        - name: Backup original sshd_config
          copy:
            src: /etc/ssh/sshd_config
            dest: /etc/ssh/sshd_config.backup
            remote_src: yes
            force: no

        - name: Configure SSH - Disable password authentication
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?PasswordAuthentication"
            line: "PasswordAuthentication {{ ssh_password_auth }}"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Root login
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?PermitRootLogin"
            line: "PermitRootLogin {{ ssh_permit_root }}"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Max auth tries
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?MaxAuthTries"
            line: "MaxAuthTries {{ ssh_max_auth_tries }}"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Client alive interval
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?ClientAliveInterval"
            line: "ClientAliveInterval {{ ssh_client_alive_interval }}"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Client alive count
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?ClientAliveCountMax"
            line: "ClientAliveCountMax {{ ssh_client_alive_count }}"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Disable empty passwords
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?PermitEmptyPasswords"
            line: "PermitEmptyPasswords no"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Protocol 2 only
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?Protocol"
            line: "Protocol 2"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Disable X11 forwarding
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?X11Forwarding"
            line: "X11Forwarding no"
            state: present
          notify: Restart SSH

        - name: Configure SSH - Log level
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "^#?LogLevel"
            line: "LogLevel VERBOSE"
            state: present
          notify: Restart SSH

    # =========================================================================
    # PHASE 3: Firewall Configuration (UFW)
    # =========================================================================
    - name: "PHASE 3: Firewall Configuration"
      tags: [firewall]
      block:
        - name: Reset UFW to defaults
          ufw:
            state: reset

        - name: Set UFW default deny incoming
          ufw:
            direction: incoming
            policy: deny

        - name: Set UFW default allow outgoing
          ufw:
            direction: outgoing
            policy: allow

        - name: Allow WireGuard port from anywhere (required for mesh)
          ufw:
            rule: allow
            port: "51820"
            proto: udp
            comment: "WireGuard VPN"

        - name: Allow SSH from WireGuard network only
          ufw:
            rule: allow
            src: "{{ wireguard_network }}"
            port: "{{ ansible_port | default(22) }}"
            proto: tcp
            comment: "SSH from WireGuard network"

        - name: Allow all traffic from WireGuard network
          ufw:
            rule: allow
            src: "{{ wireguard_network }}"
            comment: "Trust WireGuard network"

        # Cho phép PostgreSQL từ App tier (nếu là DB node)
        - name: Allow PostgreSQL from WireGuard network (DB nodes)
          ufw:
            rule: allow
            src: "{{ wireguard_network }}"
            port: "5432"
            proto: tcp
            comment: "PostgreSQL from trusted network"
          when: "'db_nodes' in group_names"

        # Cho phép HTTP/HTTPS từ WireGuard (nếu là App node)
        - name: Allow HTTP from WireGuard network (App nodes)
          ufw:
            rule: allow
            src: "{{ wireguard_network }}"
            port: "80"
            proto: tcp
            comment: "HTTP from trusted network"
          when: "'app_nodes' in group_names"

        - name: Allow HTTPS from WireGuard network (App nodes)
          ufw:
            rule: allow
            src: "{{ wireguard_network }}"
            port: "443"
            proto: tcp
            comment: "HTTPS from trusted network"
          when: "'app_nodes' in group_names"

        - name: Enable UFW
          ufw:
            state: enabled

        - name: Show UFW status
          command: ufw status verbose
          register: ufw_status
          changed_when: false

        - name: Display UFW rules
          debug:
            var: ufw_status.stdout_lines

    # =========================================================================
    # PHASE 4: Fail2ban Configuration
    # =========================================================================
    - name: "PHASE 4: Fail2ban Configuration"
      tags: [fail2ban]
      block:
        - name: Create fail2ban local config
          copy:
            dest: /etc/fail2ban/jail.local
            content: |
              [DEFAULT]
              bantime = {{ fail2ban_bantime }}
              findtime = {{ fail2ban_findtime }}
              maxretry = {{ fail2ban_maxretry }}
              
              # Ignore WireGuard network (trusted)
              ignoreip = 127.0.0.1/8 ::1 {{ wireguard_network }}
              
              # Email notifications (optional)
              # destemail = admin@example.com
              # sender = fail2ban@example.com
              # mta = sendmail
              
              [sshd]
              enabled = true
              port = {{ ansible_port | default(22) }}
              filter = sshd
              logpath = /var/log/auth.log
              maxretry = {{ fail2ban_maxretry }}
              bantime = {{ fail2ban_bantime }}
              
              [sshd-ddos]
              enabled = true
              port = {{ ansible_port | default(22) }}
              filter = sshd-ddos
              logpath = /var/log/auth.log
              maxretry = 6
              bantime = {{ fail2ban_bantime * 2 }}
          notify: Restart Fail2ban

        - name: Enable and start fail2ban
          systemd:
            name: fail2ban
            enabled: yes
            state: started

        - name: Check fail2ban status
          command: fail2ban-client status
          register: fail2ban_status
          changed_when: false

        - name: Display fail2ban status
          debug:
            var: fail2ban_status.stdout_lines

    # =========================================================================
    # PHASE 5: Audit Logging
    # =========================================================================
    - name: "PHASE 5: Audit Logging"
      tags: [audit]
      block:
        - name: Create audit rules for security events
          copy:
            dest: /etc/audit/rules.d/security.rules
            content: |
              # Monitor authentication events
              -w /etc/passwd -p wa -k identity
              -w /etc/group -p wa -k identity
              -w /etc/shadow -p wa -k identity
              -w /etc/sudoers -p wa -k sudoers
              -w /etc/sudoers.d/ -p wa -k sudoers
              
              # Monitor SSH configuration
              -w /etc/ssh/sshd_config -p wa -k sshd_config
              
              # Monitor WireGuard configuration
              -w /etc/wireguard/ -p wa -k wireguard
              
              # Monitor Docker
              -w /etc/docker/ -p wa -k docker
              -w /var/lib/docker/ -p wa -k docker
              
              # Monitor system calls for privilege escalation
              -a always,exit -F arch=b64 -S execve -k exec
              
              # Monitor network configuration changes
              -w /etc/hosts -p wa -k hosts
              -w /etc/network/ -p wa -k network
              
              # Monitor cron
              -w /etc/crontab -p wa -k cron
              -w /etc/cron.d/ -p wa -k cron
              -w /etc/cron.daily/ -p wa -k cron
              -w /etc/cron.hourly/ -p wa -k cron
              -w /etc/cron.monthly/ -p wa -k cron
              -w /etc/cron.weekly/ -p wa -k cron
              
              # Monitor login/logout
              -w /var/log/lastlog -p wa -k logins
              -w /var/run/faillock/ -p wa -k logins
          notify: Restart Auditd

        - name: Enable and start auditd
          systemd:
            name: auditd
            enabled: yes
            state: started

    # =========================================================================
    # PHASE 6: Kernel Hardening
    # =========================================================================
    - name: "PHASE 6: Kernel Hardening"
      tags: [kernel]
      block:
        - name: Apply kernel security parameters
          sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            sysctl_set: yes
            state: present
            reload: yes
          loop:
            # Network security
            - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.accept_redirects", value: "0" }
            - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.send_redirects", value: "0" }
            - { name: "net.ipv4.conf.all.accept_source_route", value: "0" }
            - { name: "net.ipv4.conf.default.accept_source_route", value: "0" }
            - { name: "net.ipv4.conf.all.log_martians", value: "1" }
            - { name: "net.ipv4.conf.default.log_martians", value: "1" }
            - { name: "net.ipv4.icmp_echo_ignore_broadcasts", value: "1" }
            - { name: "net.ipv4.icmp_ignore_bogus_error_responses", value: "1" }
            - { name: "net.ipv4.tcp_syncookies", value: "1" }
            - { name: "net.ipv4.conf.all.rp_filter", value: "1" }
            - { name: "net.ipv4.conf.default.rp_filter", value: "1" }
            
            # Disable IPv6 if not used
            - { name: "net.ipv6.conf.all.disable_ipv6", value: "1" }
            - { name: "net.ipv6.conf.default.disable_ipv6", value: "1" }
            
            # Memory protection
            - { name: "kernel.randomize_va_space", value: "2" }
            - { name: "kernel.kptr_restrict", value: "2" }
            - { name: "kernel.dmesg_restrict", value: "1" }
            
            # File system hardening
            - { name: "fs.protected_hardlinks", value: "1" }
            - { name: "fs.protected_symlinks", value: "1" }
            - { name: "fs.suid_dumpable", value: "0" }

    # =========================================================================
    # PHASE 7: Automatic Security Updates
    # =========================================================================
    - name: "PHASE 7: Automatic Security Updates"
      tags: [updates, auto-updates]
      block:
        - name: Configure unattended-upgrades
          copy:
            dest: /etc/apt/apt.conf.d/50unattended-upgrades
            content: |
              Unattended-Upgrade::Allowed-Origins {
                  "${distro_id}:${distro_codename}";
                  "${distro_id}:${distro_codename}-security";
                  "${distro_id}ESMApps:${distro_codename}-apps-security";
                  "${distro_id}ESM:${distro_codename}-infra-security";
              };
              
              Unattended-Upgrade::Package-Blacklist {
              };
              
              Unattended-Upgrade::DevRelease "false";
              Unattended-Upgrade::AutoFixInterruptedDpkg "true";
              Unattended-Upgrade::MinimalSteps "true";
              Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
              Unattended-Upgrade::Remove-Unused-Dependencies "true";
              Unattended-Upgrade::Automatic-Reboot "false";
              Unattended-Upgrade::Automatic-Reboot-Time "02:00";

        - name: Enable automatic updates
          copy:
            dest: /etc/apt/apt.conf.d/20auto-upgrades
            content: |
              APT::Periodic::Update-Package-Lists "1";
              APT::Periodic::Download-Upgradeable-Packages "1";
              APT::Periodic::AutocleanInterval "7";
              APT::Periodic::Unattended-Upgrade "1";

    # =========================================================================
    # PHASE 8: Final Security Checks
    # =========================================================================
    - name: "PHASE 8: Security Verification"
      tags: [verify]
      block:
        - name: Verify SSH config
          command: sshd -t
          register: ssh_test
          changed_when: false
          failed_when: ssh_test.rc != 0

        - name: Verify UFW is active
          command: ufw status
          register: ufw_verify
          changed_when: false

        - name: Verify fail2ban is running
          command: systemctl is-active fail2ban
          register: fail2ban_verify
          changed_when: false

        - name: Verify auditd is running
          command: systemctl is-active auditd
          register: auditd_verify
          changed_when: false

        - name: Security Status Summary
          debug:
            msg: |
              ╔══════════════════════════════════════════════════════════════╗
              ║              SECURITY HARDENING COMPLETE                      ║
              ╠══════════════════════════════════════════════════════════════╣
              ║  SSH Config:     {{ 'VALID' if ssh_test.rc == 0 else 'INVALID' }}
              ║  UFW Firewall:   {{ 'ACTIVE' if 'active' in ufw_verify.stdout else 'INACTIVE' }}
              ║  Fail2ban:       {{ fail2ban_verify.stdout | upper }}
              ║  Audit Logging:  {{ auditd_verify.stdout | upper }}
              ╠══════════════════════════════════════════════════════════════╣
              ║  WireGuard Network: {{ wireguard_network }}                   ║
              ║  SSH Access: WireGuard IPs only                              ║
              ║  Auto Updates: Enabled                                        ║
              ╚══════════════════════════════════════════════════════════════╝

  handlers:
    - name: Restart SSH
      systemd:
        name: sshd
        state: reloaded

    - name: Restart Fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: Restart Auditd
      systemd:
        name: auditd
        state: restarted
