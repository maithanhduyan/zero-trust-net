---
# =============================================================================
# DEPLOY WORKER NODES - Cháº¡y tá»« Control Plane
# =============================================================================
# Playbook nÃ y cháº¡y Tá»ª CONTROL PLANE Ä‘á»ƒ tá»± Ä‘á»™ng:
#   1. SSH vÃ o cÃ¡c worker nodes
#   2. CÃ i Ä‘áº·t WireGuard
#   3. Generate keys
#   4. Thu tháº­p public keys
#   5. Tá»± Ä‘á»™ng thÃªm peers vÃ o Hub
#
# Usage:
#   # Deploy táº¥t cáº£ worker nodes
#   ansible-playbook playbooks/deploy-worker-nodes.yml
#
#   # Deploy chá»‰ db_nodes
#   ansible-playbook playbooks/deploy-worker-nodes.yml --limit db_nodes
#
#   # Deploy má»™t node cá»¥ thá»ƒ
#   ansible-playbook playbooks/deploy-worker-nodes.yml --limit db-primary
#
# Prerequisites:
#   - SSH key Ä‘Ã£ Ä‘Æ°á»£c copy Ä‘áº¿n cÃ¡c nodes
#   - inventory/hosts.ini Ä‘Ã£ cÃ³ thÃ´ng tin cÃ¡c nodes
# =============================================================================

# =============================================================================
# PHASE 1: Setup WireGuard trÃªn táº¥t cáº£ Worker Nodes
# =============================================================================
- name: Setup WireGuard on Worker Nodes
  hosts: worker_nodes
  become: yes
  gather_facts: yes
  
  vars:
    wg_hub_endpoint: "{{ hostvars[groups['control_plane'][0]]['ansible_host'] }}"
    wg_hub_public_key: "{{ hostvars[groups['control_plane'][0]]['wg_public_key'] }}"
    wg_hub_address: "{{ hostvars[groups['control_plane'][0]]['wg_address'] | default('10.10.0.1') }}"
  
  tasks:
    - name: Display node info
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  ğŸ–¥ï¸  Setting up: {{ inventory_hostname }}
          â•‘  Public IP: {{ ansible_host }}
          â•‘  WireGuard IP: {{ wg_address }}
          â•‘  Hub: {{ wg_hub_endpoint }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # =========================================================================
    # Install WireGuard
    # =========================================================================
    - name: Install WireGuard
      apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
        update_cache: yes

    - name: Enable IP forwarding
      sysctl:
        name: "{{ item }}"
        value: "1"
        sysctl_file: /etc/sysctl.d/99-wireguard.conf
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    # =========================================================================
    # Generate Keys
    # =========================================================================
    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'

    - name: Check if private key exists
      stat:
        path: /etc/wireguard/private.key
      register: wg_key_exists

    - name: Generate WireGuard keys
      shell: wg genkey | tee /etc/wireguard/private.key | wg pubkey > /etc/wireguard/public.key
      when: not wg_key_exists.stat.exists

    - name: Secure private key
      file:
        path: /etc/wireguard/private.key
        mode: '0600'

    - name: Read private key
      slurp:
        src: /etc/wireguard/private.key
      register: wg_private_key_content

    - name: Read public key
      slurp:
        src: /etc/wireguard/public.key
      register: wg_public_key_content

    - name: Set key facts
      set_fact:
        wg_private_key: "{{ wg_private_key_content.content | b64decode | trim }}"
        wg_public_key_generated: "{{ wg_public_key_content.content | b64decode | trim }}"

    # =========================================================================
    # Create WireGuard Config
    # =========================================================================
    - name: Create WireGuard configuration
      copy:
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
        content: |
          # =============================================================================
          # WORKER NODE: {{ inventory_hostname }}
          # =============================================================================
          # Generated: {{ ansible_date_time.iso8601 }}
          # WireGuard IP: {{ wg_address }}
          # =============================================================================
          
          [Interface]
          PrivateKey = {{ wg_private_key }}
          Address = {{ wg_address }}/24
          
          # =============================================================================
          # CONTROL PLANE (Hub)
          # =============================================================================
          [Peer]
          # Control Plane Hub
          PublicKey = {{ wg_hub_public_key }}
          Endpoint = {{ wg_hub_endpoint }}:51820
          AllowedIPs = 10.10.0.0/24
          PersistentKeepalive = 25
      notify: restart wireguard

    - name: Enable and start WireGuard
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started

    - name: Store public key for later use
      set_fact:
        node_wg_public_key: "{{ wg_public_key_generated }}"
        node_wg_address: "{{ wg_address }}"
        node_name: "{{ inventory_hostname }}"

  handlers:
    - name: restart wireguard
      systemd:
        name: wg-quick@wg0
        state: restarted

# =============================================================================
# PHASE 2: Thu tháº­p public keys vÃ  cáº­p nháº­t Hub
# =============================================================================
- name: Update Hub with all Worker Peers
  hosts: control_plane
  become: yes
  
  tasks:
    - name: Display collected peers
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  ğŸ“¥ Thu tháº­p peers tá»« Worker Nodes...                                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Build peer configurations
      set_fact:
        peer_configs: |
          {% for host in groups['worker_nodes'] %}
          {% if hostvars[host]['node_wg_public_key'] is defined %}
          
          [Peer]
          # {{ host }}
          PublicKey = {{ hostvars[host]['node_wg_public_key'] }}
          AllowedIPs = {{ hostvars[host]['node_wg_address'] }}/32
          {% endif %}
          {% endfor %}

    - name: Read current Hub config
      slurp:
        src: /etc/wireguard/wg0.conf
      register: hub_config

    - name: Check if peers already exist
      set_fact:
        peers_to_add: []

    - name: Identify new peers to add
      set_fact:
        peers_to_add: "{{ peers_to_add + [item] }}"
      loop: "{{ groups['worker_nodes'] }}"
      when:
        - hostvars[item]['node_wg_public_key'] is defined
        - hostvars[item]['node_wg_public_key'] not in (hub_config.content | b64decode)

    - name: Add new peers to Hub config
      blockinfile:
        path: /etc/wireguard/wg0.conf
        marker: "# {mark} ANSIBLE MANAGED - {{ item }}"
        block: |
          [Peer]
          # {{ item }}
          PublicKey = {{ hostvars[item]['node_wg_public_key'] }}
          AllowedIPs = {{ hostvars[item]['node_wg_address'] }}/32
      loop: "{{ peers_to_add }}"
      notify: sync wireguard config

    - name: Display results
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… WORKER NODES DEPLOYED!                                       â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          {% for host in groups['worker_nodes'] %}
          {% if hostvars[host]['node_wg_public_key'] is defined %}
          â•‘  âœ“ {{ host }}: {{ hostvars[host]['node_wg_address'] }}
          {% endif %}
          {% endfor %}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  handlers:
    - name: sync wireguard config
      shell: wg syncconf wg0 <(wg-quick strip wg0)
      args:
        executable: /bin/bash

# =============================================================================
# PHASE 3: Verify Connectivity
# =============================================================================
- name: Verify WireGuard Mesh Connectivity
  hosts: worker_nodes
  become: yes
  
  tasks:
    - name: Wait for WireGuard to establish connection
      pause:
        seconds: 3

    - name: Test connectivity to Hub
      command: ping -c 3 -W 5 10.10.0.1
      register: ping_result
      ignore_errors: yes
      changed_when: false

    - name: Display connectivity status
      debug:
        msg: "{{ inventory_hostname }} â†’ Hub (10.10.0.1): {{ 'CONNECTED âœ…' if ping_result.rc == 0 else 'FAILED âŒ' }}"
