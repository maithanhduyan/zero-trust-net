---
# =============================================================================
# SETUP FULL MESH - Káº¿t ná»‘i P2P giá»¯a cÃ¡c nodes
# =============================================================================
# Playbook nÃ y thÃªm direct peer connections giá»¯a cÃ¡c worker nodes
# Ä‘á»ƒ loáº¡i bá» Single Point of Failure (SPOF)
#
# Sau khi cháº¡y:
#   - CÃ¡c nodes váº«n káº¿t ná»‘i qua Hub
#   - NHÆ¯NG cÅ©ng cÃ³ thá»ƒ káº¿t ná»‘i trá»±c tiáº¿p vá»›i nhau
#   - Náº¿u Hub fail â†’ nodes váº«n giao tiáº¿p Ä‘Æ°á»£c
#
# Usage:
#   ansible-playbook playbooks/setup-full-mesh.yml
# =============================================================================

- name: Gather all node information
  hosts: worker_nodes
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Get public IP
      shell: curl -s ifconfig.me || curl -s icanhazip.com
      register: public_ip_result
      changed_when: false

    - name: Read WireGuard public key
      slurp:
        src: /etc/wireguard/public.key
      register: wg_pubkey

    - name: Get current WireGuard port
      shell: grep -oP 'ListenPort\s*=\s*\K\d+' /etc/wireguard/wg0.conf || echo "51820"
      register: wg_port_result
      changed_when: false

    - name: Store node info
      set_fact:
        node_info:
          name: "{{ inventory_hostname }}"
          wg_address: "{{ wg_address }}"
          public_ip: "{{ public_ip | default(public_ip_result.stdout) }}"
          public_key: "{{ wg_pubkey.content | b64decode | trim }}"
          wg_port: "{{ wg_port_result.stdout | default('51820') }}"
          ssh_port: "{{ ansible_port | default(22) }}"

- name: Configure Full Mesh on each node
  hosts: worker_nodes
  become: yes
  serial: 1  # One at a time to avoid race conditions
  
  tasks:
    - name: Display mesh configuration
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  ðŸ”— Configuring Full Mesh for: {{ inventory_hostname }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Ensure node has ListenPort configured
      lineinfile:
        path: /etc/wireguard/wg0.conf
        regexp: '^ListenPort'
        line: "ListenPort = 51820"
        insertafter: '^\[Interface\]'
      notify: reload wireguard

    - name: Build peer configurations for other workers
      set_fact:
        peer_configs: |
          {% for host in groups['worker_nodes'] %}
          {% if host != inventory_hostname and hostvars[host]['node_info'] is defined %}
          
          [Peer]
          # {{ host }} (Direct P2P - Full Mesh)
          PublicKey = {{ hostvars[host]['node_info']['public_key'] }}
          Endpoint = {{ hostvars[host]['node_info']['public_ip'] }}:51820
          AllowedIPs = {{ hostvars[host]['node_info']['wg_address'] }}/32
          PersistentKeepalive = 25
          {% endif %}
          {% endfor %}

    - name: Check existing peers in config
      slurp:
        src: /etc/wireguard/wg0.conf
      register: current_config

    - name: Add peer configurations for full mesh
      blockinfile:
        path: /etc/wireguard/wg0.conf
        marker: "# {mark} FULL MESH PEERS - Ansible Managed"
        block: "{{ peer_configs }}"
      notify: reload wireguard
      when: peer_configs | trim | length > 0

  handlers:
    - name: reload wireguard
      shell: wg syncconf wg0 <(wg-quick strip wg0)
      args:
        executable: /bin/bash

- name: Verify Full Mesh Connectivity
  hosts: worker_nodes
  become: yes
  
  tasks:
    - name: Wait for mesh to establish
      pause:
        seconds: 3

    - name: Test connectivity to all other nodes
      command: "ping -c 2 -W 3 {{ hostvars[item]['wg_address'] }}"
      loop: "{{ groups['worker_nodes'] | difference([inventory_hostname]) }}"
      register: ping_results
      ignore_errors: yes
      changed_when: false

    - name: Display connectivity results
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  {{ inventory_hostname }} Mesh Connectivity:
          {% for result in ping_results.results %}
          â•‘  â†’ {{ result.item }}: {{ 'âœ… Connected' if result.rc == 0 else 'âŒ Failed' }}
          {% endfor %}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Display Final Mesh Status
  hosts: localhost
  connection: local
  
  tasks:
    - name: Show mesh summary
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… FULL MESH NETWORK CONFIGURED!                                â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                                              â•‘
          â•‘                        Hub (10.10.0.1)                                       â•‘
          â•‘                       â•±            â•²                                         â•‘
          â•‘                      â•±              â•²                                        â•‘
          â•‘            db-primary â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º db-replica                              â•‘
          â•‘            (10.10.0.10)   Direct    (10.10.0.11)                              â•‘
          â•‘                                                                              â•‘
          â•‘  âœ“ Táº¥t cáº£ nodes cÃ³ thá»ƒ káº¿t ná»‘i trá»±c tiáº¿p vá»›i nhau                            â•‘
          â•‘  âœ“ Náº¿u Hub fail â†’ Nodes váº«n giao tiáº¿p Ä‘Æ°á»£c                                   â•‘
          â•‘  âœ“ No Single Point of Failure                                                â•‘
          â•‘                                                                              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
