---
# =============================================================================
# LOCKDOWN SSH - Chỉ cho phép SSH qua WireGuard
# =============================================================================
# ⚠️  QUAN TRỌNG: Chỉ chạy playbook này SAU KHI WireGuard đã hoạt động!
#
# Playbook này sẽ:
#   1. Cấu hình UFW chỉ cho phép SSH từ WireGuard network (10.10.0.0/24)
#   2. Block SSH từ public internet
#   3. Giữ WireGuard port (51820/UDP) mở
#
# Usage:
#   # Kiểm tra trước
#   ansible-playbook playbooks/lockdown-ssh.yml --check
#
#   # Áp dụng
#   ansible-playbook playbooks/lockdown-ssh.yml
#
# ⚠️  SAU KHI CHẠY: Chỉ có thể SSH qua WireGuard IP!
# =============================================================================

- name: Lockdown SSH - Zero Trust Mode
  hosts: worker_nodes
  become: yes
  
  vars:
    wg_network: "10.10.0.0/24"
    ssh_port: "{{ ansible_port | default(22) }}"
  
  pre_tasks:
    - name: Verify WireGuard is running
      command: wg show wg0
      register: wg_status
      changed_when: false
      failed_when: wg_status.rc != 0

    - name: Verify connectivity to Hub via WireGuard
      command: ping -c 2 -W 3 10.10.0.1
      register: ping_hub
      changed_when: false
      failed_when: ping_hub.rc != 0

    - name: Display warning
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════════╗
          ║  ⚠️  WARNING: SSH LOCKDOWN                                           ║
          ╠══════════════════════════════════════════════════════════════════════╣
          ║                                                                      ║
          ║  Sau khi chạy playbook này:                                          ║
          ║  • SSH từ Internet sẽ bị BLOCK                                       ║
          ║  • Chỉ có thể SSH qua WireGuard IP: {{ wg_address }}
          ║                                                                      ║
          ║  Từ Hub Server, SSH bằng:                                            ║
          ║  ssh root@{{ wg_address }}                                           ║
          ║                                                                      ║
          ╚══════════════════════════════════════════════════════════════════════╝

    - name: Pause for confirmation
      pause:
        prompt: "Nhấn Enter để tiếp tục hoặc Ctrl+C để hủy"
      when: not ansible_check_mode

  tasks:
    # =========================================================================
    # INSTALL UFW
    # =========================================================================
    - name: Install UFW
      apt:
        name: ufw
        state: present
        update_cache: yes

    # =========================================================================
    # CONFIGURE UFW RULES
    # =========================================================================
    - name: Reset UFW to default
      ufw:
        state: reset

    - name: Set default incoming policy to deny
      ufw:
        direction: incoming
        policy: deny

    - name: Set default outgoing policy to allow
      ufw:
        direction: outgoing
        policy: allow

    - name: Allow WireGuard port from anywhere
      ufw:
        rule: allow
        port: "51820"
        proto: udp
        comment: "WireGuard VPN"

    - name: Allow SSH ONLY from WireGuard network
      ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp
        from_ip: "{{ wg_network }}"
        comment: "SSH from WireGuard only"

    - name: Allow all traffic on WireGuard interface
      ufw:
        rule: allow
        interface: wg0
        direction: in
        comment: "Allow all WireGuard traffic"

    # =========================================================================
    # ENABLE UFW
    # =========================================================================
    - name: Enable UFW
      ufw:
        state: enabled

    - name: Get UFW status
      command: ufw status verbose
      register: ufw_status
      changed_when: false

    - name: Display UFW status
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════════╗
          ║  ✅ SSH LOCKDOWN COMPLETE                                            ║
          ╠══════════════════════════════════════════════════════════════════════╣
          {{ ufw_status.stdout }}
          ╚══════════════════════════════════════════════════════════════════════╝

  post_tasks:
    - name: Verify SSH still works via WireGuard
      wait_for:
        host: "{{ wg_address }}"
        port: "{{ ssh_port }}"
        timeout: 10
      delegate_to: localhost

    - name: Final confirmation
      debug:
        msg: |
          ✅ Node {{ inventory_hostname }} đã được bảo mật!
          
          SSH bây giờ CHỈ hoạt động qua WireGuard:
            ssh -p {{ ssh_port }} root@{{ wg_address }}
          
          SSH từ Internet đã bị BLOCK!
